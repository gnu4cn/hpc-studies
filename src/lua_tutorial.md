# Lua 教程

因为在 [Slurm 集群负载调度器](https://slurm.schedmd.com/) 部署中，会用到用 Lua 实现的 [Lmod](https://github.com/TACC/Lmod) 这个环境模块系统，故有必要了解 Lua 这门编程语言。


## 前言

目前，许多编程语言都在关注如何帮助咱们，编写成千上万行的程序。为此，他们为咱们提供了软件包、命名空间、复杂类型系统、无数种结构，以及成千上万页可供学习的文档。


Lua 并不试图帮助咱们编写成千上万行的程序。相反，Lua 试图帮助咱们，只用几百行，甚至更少代码行来解决问题。为实现这一目标，Lua 和许多其他语言一样，依赖于 *可扩展性，extensibility*。不过，与大多数其他语言不同的是，Lua 不仅可以用 Lua 本身，编写的软件进行扩展，还可以用 C 和 C++ 等其他语言，编写的软件进行扩展。

Lua 从一开始，就是为与 C 语言，及其他传统语言编写的软件集成，而设计的。这种语言双重性，带来了许多好处。Lua 是一种微小，且简单的语言，部分原因是他并不试图，做 C 语言已经擅长的事情，譬如纯粹的性能、底层操作，或与第三方软件的接口。Lua 依靠 C 语言，完成这些任务。Lua 所提供的，是 C 语言所不擅长的：与硬件保持良好距离、动态的结构、无冗余、易于测试和调试。为此，Lua 拥有安全的环境、自动内存管理，以及处理字符串及其他动态数据的强大功能。


除了是一门可扩展的语言，Lua 还是一门 *胶水语言，glue language*。Lua 支持基于组件的软件开发方法，a component-based approach to software development，我们通过将现有的高级组件粘合在一起，来创建出应用程序。通常，这些组件是用 C 或 C++ 等静态类型语言，编写编译的；Lua 是我们用来组成，和连接这些组件的胶水。通常，组件（或对象）代表了更具体、更低级的概念（如视窗小部件及数据结构），这些具体、低级概念，在程序开发过程中不会有太多变化，并占用了最终程序的大部分 CPU 时间。Lua 提供了应用程序的最终形态，在产品的生命周期内，他们则可能会发生很大变化。不过，与其他胶水技术不同，Lua 本身也是一种成熟的语言。因此，我们不仅可以使用 Lua 来粘合组件，还可以调整和重塑组件，甚至创建出全新组件。


当然，Lua 并不是唯一的脚本语言，scripting language。咱们还可以使用其他语言，来实现大致相同的目的，例如 Perl、Tcl、Ruby、Forth 与 Python 等。Lua 有别于这些语言的特点如下；虽然其他语言与 Lua 共享了其中一些特点，但并没有其他语言，提供了类似的功能：


- *可扩展能力，extensibility*：Lua 的可扩展性非常出色，以至许多人认为，Lua 不是一门语言，而是一种用于构建特定领域语言，domain-specific languages，的工具包。Lua 从一开始，就被设计成可以通过 Lua 代码，和外部 C 代码进行扩展。作为概念验证，他通过外部库，实现了自身的大部分基本功能。将 Lua 与 C/C++，以及其他语言（如 Fortran、Java、Smalltalk、Ada，甚至其他脚本语言）连接起来，非常容易；

- *简洁，simplicity*：Lua 是一门简单而小巧的语言。他的概念很少（但功能强大）。这种简洁性使 Lua 易于学习，并有助于小型实施。他的完整发行版（源代码、手册以及某些平台的二进制文件）可轻松放入软盘中；

- *高效率，efficiency*：Lua 的实现相当高效。独立的基准测试表明，Lua 是脚本（解释型）语言领域，速度最快的语言之一；

- *可移植性，portability*：在谈论可移植性时，我们并不是在谈论，同时在 Windows 和 Unix 平台上运行 Lua。我们指的是在我们听说过的所有平台上运行 Lua： NextStep、OS/2、PlayStation II（索尼）、Mac OS-9 和 OS X、BeOS、MS-DOS、IBM 大型机、EPOC、PalmOS、MCF5206eLITE 评估板、RISC OS，当然还有各种 Unix 和 Windows。这些平台的源代码几乎相同。Lua 不使用条件编译，来使代码适应不同的机器；相反，他坚持使用标准 ANSI (ISO) C： 如果咱们有 ANSI C 编译器，只需编译 Lua 即可。


Lua 的大部分能力，都来自他的库。这并非偶然。Lua 的主要优势之一，便是其通过一些新类型及新函数，实现的可扩展性。许多特性，都有助于增强这一优势。动态类型，允许很大程度的多态，polymorphism。自动的内存管理简化了接口，因为无需决定由谁，负责分配和取消分配内存，也无需决定，如何处理内存溢出。高阶函数与匿名函数，允许高度参数化，使函数用途更加广泛。

Lua 附带了一套小型的标准库。在诸如嵌入式处理器等限制较多的环境中，安装 Lua 时，谨慎选择所需的库，可能是明智之举。此外，如果限制条件苛刻，则可以很容易地进入库的源代码，逐一选择需要保留的功能。不过，请记住，Lua 的体积很小（即使包含所有标准库），在大多数系统中，咱们都可以毫无顾虑地，使用整个软件包。


## 受众群体

Lua 用户通常分为三大类：在应用程序中嵌入 Lua 的用户、单独使用 Lua 的用户，以及同时使用 Lua 和 C 语言的用户。


许多人将 Lua 嵌入到应用程序中，如 [CGILua](https://github.com/lunarmodules/cgilua)（用于构建动态网页）或 [LuaOrb](https://www.tecgraf.puc-rio.br/luaorb/)（用于访问 CORBA 对象）。这些应用程序，使用 Lua-C API，来注册新函数、创建新类型，并更改某些语言操作的行为，从而为其特定领域配置 Lua。通常，这些应用程序的用户，甚至不知道 Lua 是一门独立、适用于特定领域的语言；例如，CGILua 用户往往认为，Lua 是一种专门为网络设计的语言。


Lua 作为一门独立的语言，也很有用，主要用于文本处理和一次性小程序，one-shot programs。对于此类用途，Lua 的主要功能来自其标准库，这些库提供了模式匹配，及其他字符串处理的功能。我们可以将这种独立语言，视为 Lua 在字符串和（文本）文件处理领域的嵌入。

最后，还有一些程序员在工作台的另一侧工作，编写将 Lua 作为库，使用的应用程序。尽管他们需要对 Lua 有很好的理解，才能创建出简单、易用，且与 Lua 语言完美结合的用户界面，但他们更多的是使用 C 语言，而非 Lua 进行编程。


本书可以为所有这些人，提供很多帮助。第一部分涉及到语言本身，向我们展示了，如何挖掘语言的所有潜力。我们将重点放在不同的语言结构上，并使用大量示例，来展示如何在实际任务中使用这些结构。这部分的一些章节，涉及基本概念，如控制结构。但也有一些高级（和原创）主题，如迭代器和例程，coroutines。


第二部分，专门介绍 Lua 中唯一的数据结构 -- 表格。其中的章节讨论了数据结构、持久性、包及面向对象编程。在这里，我们将揭示 Lua 语言的真正威力。


第三部分介绍标准库。这一部分对于将 Lua 作为独立语言使用的人们，特别有用，尽管许多其他应用程序，也包含全部或部分标准库。这部分用一章的篇幅，介绍了每个标准库：数学库、表格库、字符串库、I/O 库、操作系统库和调试库。


最后，本书的最后一部分，介绍了 Lua 和 C 之间的 API，供使用 C 来充分发挥 Lua 功能的读者参考。这部分的内容，必然与本书其他部分的内容大相径庭。在这里，我们将使用 C，而不是 Lua 进行编程；因此，我们将戴上一顶不同的帽子。对于某些读者来说，对 C API 的讨论，可能兴趣不大；而对于另一些读者来说，这可能是本书最相关的部分。
