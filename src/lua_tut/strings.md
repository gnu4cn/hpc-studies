# 字符串

字符串表示文本。Lua 中的字符串，可以包含单个的字母，或一整本书。在 Lua 中，处理有着 10 万或 100 万字符的字符串的程序，并不罕见。


Lua 中的字符串，是一些字节序列。Lua 内核，the Lua core，并不考虑这些字节如何编码文本。Lua 采用八位编码，Lua is eight-bit clean，其字符串可以包含任何数字编码的字节，包括嵌入的零。这意味着，我们可以将任何二进制数据，存储到字符串中。我们还可以任何表示形式（UTF-8、UTF-16 等），存储 Unicode 的字符串；不过，正如我们将要讨论的，有几个很好的理由，让我们尽可能使用 UTF-8。Lua 自带的标准字符串库，假定使用单字节字符，但他可以相当合理地处理 UTF-8 字符串。此外，从 5.3 版开始，Lua 自带了一个小型库，来帮助使用 UTF-8 编码。


Lua 中的字符串，是一些不可更改的值，immutable values。我们不能像在 C 语言中那样，更改字符串中的某个字符；相反，我们要创建一个新的字符串，并进行所需的修改，如下面的示例：


```lua
> a = "one string"
> b = string.gsub(a, "one", "another")
> a
one string
> b
another string
```


Lua 中的字符串，与所有其他 Lua 对象（表、函数等）一样，都属于自动内存管理对象。这意味着，我们不必担心字符串的内存分配和取消分配，Lua 会为我们处理。


我们可以使用长度运算符（用 `#` 表示），来获取字符串的长度：

```lua
> #a
10
> #b
14
>
> #"goodbye"
7
```

该运算符始终是以字节为单位，计算长度，而不同于某些编码中的字符。


我们可以使用连接运算符 `..`（两个点），将两个字符串连接起来。如果操作数是数字，Lua 会将其转换为字符串：


```lua
> "Hello ".."World"
Hello World
> "Result is "..3
Result is 3
```

（有些语言会使用加号表示连接，但 `3 + 5` 与 `3 .. 5` 是不同的）。


请记住，Lua 中的字符串是不可变值。连接操作符总是会创建出一个新字符串，而不会对操作数进行任何修改：


```lua
> a = "Hello"
> a .. " World"
Hello World
> a
Hello
```


## 字面的字符串

**Literal strings**


我们可以用成对的单引号或双引号，对字面字符串进行定界，delimit literal strings by single or double matching quotes：


```lua
> a = "a line"
> b = 'another line'
```


他们是等价的；唯一的区别是，在一种引号内，我们可以使用不带转义的另一种引号。


```lua
> a = "It's a line"
> a
It's a line
> b = 'He said, "We can win"'
> b
He said, "We can win"
```

作为一种风格，大多数程序员，总是会为同类字符串，使用同一种引号，字符串的 “类别”，the "kinds" of strings，取决于程序。例如，处理 XML 的库，可能会为 XML 代码片段，保留单引号字符串，因为这些片段通常包含双引号。


Lua 中的字符串，可以包含以下的类似 C 语言的转义序列：


| 转义 | 意义 |
| :-- | :-- |
| `\a` | 铃声 |
| `\b` | 退格 |
| `\f` | 换页（form feed） |
| `\n` | 换行 |
| `\r` | 回车（carriage return） |
| `\t` | 水平制表位（horizontal tab） |
| `\v` | 垂直制表位（vertical tab） |
| `\\` | 反斜杠（backslash） |
| `\"` | 双引号 |
| `\'` | 单引号 |


下面的例子，说明了他们的用途：


```lua
> print("one line\nnext line\n\"in quotes\", 'in quotes'")
one line
next line
"in quotes", 'in quotes'
> print('a backslash inside quotes: \'\\\'')
a backslash inside quotes: '\'
> print("a simple way: '\\'")
a simple way: '\'
```


经由转义序列 `\ddd` 和 `\xhh`，我们还可以通过其数值，指定出字面字符串中的字符，其中 `ddd` 是最多三个十进制位的序列，`hh` 是两个十六进制位的序列。举一个有点刻意人为的例子，`"ALO/n123/"` 和 `"\x41LO\10/04923"` 这两个字面值，在使用 ASCII 码的系统中具有相同的值：`0x41`（十进制 `65`），他是 `A` 的 ASCII 码，`10` 是换行的代码，`49` 是数字 `1` 的代码。(在这个例子中，我们必须将 `49` 写成三个数字，即 `\049`，因为它后面还有另一个数字；否则 Lua 会将转义字符读成 `\492`）。我们也可以将同样的字符串，写成 `"x41\x4c\x4f\x0a\x31\x32\x33\x22"`, 用十六进制代码来表示每个字符。


```lua
> "ALO\n123\""
ALO
123"
> '\x41LO\10\04923"'
ALO
123"
>
> '\x41\x4c\x4f\x0a\x31\x33\x22'
ALO
13"
```


自 Lua 5.3 起，我们还可以使用转义序列 `\u{h...h}`，来指定 UTF-8 字符；我们可以在括号内，写入任意数量的十六进制数字：


```lua
> "\u{3b1} \u{3b2} \u{3b3}"
α β γ
```

(以上示例假定使用 UTF-8 终端）。


## 长字符串

**Long strings**


我们也可以通过成对的双方括号，来给字面字符串定界，就像我们之前给长注释定界一样。这种括号形式的字面字符串，可以长达数行，并且不会解释转义序列。此外，如果字符串的第一个字符是换行符，其会忽略该字符串的第一个字符。在写下包含了大量代码的字符串时，这种形式尤其方便，例如下面的示例：


```lua
> page = [[
>> <html>
>> <head>
>>      <title>An HTML Page</title>
>> </head>
>> <body>
>>      <a href="https://www.lua.org">Lua</a>
>> </body>
>> </html>
>> ]]
> page
<html>
<head>
        <title>An HTML Page</title>
</head>
<body>
        <a href="https://www.lua.org">Lua</a>
</body>
</html>
```

有时，我们可能需要将一段包含 `a = b[c[i]]`，这样内容的代码括起来（请注意这段代码中的 `]]`），或者可能需要将一些已经注释掉的代码括起来。为了处理这种情况，我们可以在两个方括号之间，添加任意数量的等号，如 `[===[`。更改后，字面字符串就只会在下一个其间的等号个数相同的括号处结束（在我们的示例中为 `]===]`）。扫描程序，the scanner，会忽略等号个数不同的任何一对括号。通过选择适当的等号个数，我们可以括住任何的字面字符串，而无需对其进行任何修改。


```lua
> code = [===[
>> a = b[c[i]]
>> ]===]
> code
a = b[c[i]]

>
```


这一功能同样适用于注释。例如，如果我们用 `--[=[` 开始一条长注释，他就会一直延伸到下一个 `]=]`。通过这种方法，我们可以轻松地注释掉一段，包含已注释部分的代码。


长字符串是在代码中，包含字面文本的理想格式，但我们不应将其用于非文本的字面值。虽然 Lua 中的字面字符串，可以包含任意字节，但使用这一功能并不是一个好主意（例如，咱们的文本编辑器，就可能会出现问题）；此外，像 `"\r\n"` 这样的行结束序列，在读取时可能会被规范化为 `"\n"`。相反，最好使用十进制，或十六进制数字转义序列，对任意二进制数据进行编码，如 `"\x13\x01\xA1\xBB"`。不过，这对于长字符串来说是个问题，因为他们会造成相当长的行。针对这种情况，从 5.2 版开始，Lua 提供了转义序列 `\z`：他可以跳过字符串中所有后续的空格字符，直到第一个非空格字符。下一个示例说明了其用法：


```lua
> data = "\x00\x01\x02\x03\x04\x05\x06\x07\z
>> \x08\x09\x0A\x0B\x0C\x0D\x0E\x0F"
> data


>
```

第一行末尾的转义字符 `\z`，会跳过后面的行尾和第二行的缩进，因此在生成的字符串中，字节 `\x08` 会直接跟在 `\x07` 后面。



## 类型强制转换

**Coercions**


Lua 提供了运行时的数字和字符串之间的自动转换。任何应用到字符串的数字运算，都会尝试将字符串转换为数字。Lua 不仅在算术运算符中使用这种强制转换，而且在其他需要使用数字的地方，也使用这种强制转换，例如 `math.sin` 的参数。



